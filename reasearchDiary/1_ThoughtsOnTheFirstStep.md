# Generate Pure Spectrums, Element Matricies, and Effective Map

Previously I wanted to do a simulated field comparison of the MINS with soil harvest methods. I generated 1000 spectrums meant to simulate the MINS scanning along a field. After a restart due to mistiming the batch scripts, computation time tolotaled ~3 weeks, only to find out that the spectrums were effectively the same. I had failed to notice that, although the variance in the soil was high, the avg carbon content of the soil accross all tests had small variance, and as such were effectively the same. 
MCNP takes a long time to run, so we need quick ways to generate spectrums so as to estimate the performance of Analysis methods, Comparison with core harvest, and other studies.

The idea came from a spectral decomposition method, in which the spectrum is decomposed into a linear combination of pure spectrums. The pure spectrums are generated by MCNP, and the coefficients are determined by a least squares method. The coefficients are equivalent to the concentration of the pure samples in the soil. By reversing the process, we can simulate the spectrum of a soil sample by taking the linear combination of the pure spectrums. 

This is not equivalent to true convolution, which is more closely approximated by MCNP.

In pervious work, I looked into making more spacially dependent distributions of the elements. I wanted to be able to represent the concentrations as functions, but MCNP doesnt have that capability. Instead I did this by dividing the soil into nxmxl sections, then sampling each section with the function and assigning the composition to that section. 

Now i want to include an effective map. Lab methods rely on the measurement of a finite sample, and can be engieered and calibrated to best analyze a certain size. but in a mobile setting, the sample, being the ground, is effecively infinite, but obviously, only a finite amount of soil is measured, "cones of influence". Using MCNP, we can tally the portion of how much each subsection of the soil contributes to the measurement.

In previous work I made my own scripts for making .mcnp inputs, this time I want to use MontePy, it looks like it might have just enough where i can add a contribution that helps with the tallies. Since Ill be making changes to the code, I will need to fork it and make my own version. 
Mcnptools is used to read the tallies, which does not exist in MontePy, to replicate portions that generate mcnp code, MCNPTools must be installed. If you only have spectrums, skip to the results of the spectrum convolution. If you cant install this, youll have to find some way to get the tallies into their respective format.

First Im going to try to do this without making a fork, but if I need to make changes to the code, I will have to fork it.

04/24/2025
the first issue arises when i try and input mcnp code written by my scientists,
MontePy cannot read vertical input, im going to try and change the code to do so. 

investigating the code, it looks like the vertical input is not supported, montepy reads the input line by line, so mybe i have it join the items together in memory before splitting it before output?

04/27/2025

Lets try it.
In genmcnp.py, I have my test script.

first thing i do is enumerate the fh list
its not subscriptable!
ti goes through the file and "flushes it", which goes through the line 
this is too heavy, ill have to make a wrapper that will combine the neccessary lines, then split them afterwards.

Ill try to fix it later this summer.

should I rely on my old scripts to generate the code?

the package has a workaround by deleting the line and adding it back in inside the python code.

My idea is to input everything except the soil and air
the final script will just let you do sectioned soil with the relevant tallies given a soil composition function.


05/01/2025
Have some extra time to work on this, i need to skip the gui and just make a script that will generate the mcnp code.

05/02/2025

Im going to give the scripts from this step the id: 000000XX

05/06/2025

I have the scripts generated, Im not completely sure i made the right density calculations. I need to consult with galina.

next todo: add tallies to the make_mcnp function